**WARNING: This action deletes data. Use with care and at your own risk.**

![testrun](https://github.com/christian-korneck/delete-run-artifacts-action/workflows/testrun/badge.svg)

# delete-run-artifacts

This github action deletes all artifacts generated by a github workflow run. It's intended to be used to delete all artifacts generated by a run at the end of this run.

This can be useful if your workflow temporarily stores artifacts and they're not needed anymore by the end of the run (i.e. because they got uploaded or published as a release by one of the steps). Deleting these redundant artifacts at the end of the run saves storage space (which is limited for private repos).

# How to use

This action requires a bit more preparation in your repo than most other actions. Because artifacts cannot get deleted during a workflow run (only after a run has completed), we need to spawn a separate workflow run for the deletion by a webhook at the end of the main workflow run.

First, create a personal access token (required to call a webhook):

- in your github **user/org** settings: *Settings* -> *Developer Settings* -> *[Personal access tokens](https://github.com/settings/tokens)* -> *[generate new token](https://github.com/settings/tokens/new)*
  - *Note*: `for webhooks`
  - *Scope*: `repo` ([docs](https://developer.github.com/apps/building-oauth-apps/understanding-scopes-for-oauth-apps/))
- copy the generated token

then store the token as a secret in the repo, so that the workflow can use it:

- in your github **repo** settings: *Settings* tab -> *Secrets* -> *add a new secret*
  - *Name*: `FOR_WEBHOOKS_SECRET`
  - *Value*: `<YOUR-TOKEN>`

then create a file in your repo `.github/workflows/webhook_target.yml` with:

```
name: delete calling job's artifacts
on: repository_dispatch
jobs:
  main:
    runs-on: ubuntu-latest
    steps:
    - name: Delete artifacts
      if: github.event.action == 'delete_all_artifacts'
      uses: christian-korneck/delete-run-artifacts-action@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        parent_runid: ${{ github.event.client_payload.parent_runid  }}
        parent_repo: ${{ github.event.client_payload.parent_repo }}
```

and finally add the following job steps to your actual workflow (i.e. in `.github/workflows/workflow.yml`):

```
name: your workflow
on: [push]
  your_last_job:
    runs-on: ubuntu-latest
    name: your last job in the workflow chain
    env:
      FOR_WEBHOOKS_SECRET: ${{ secrets.FOR_WEBHOOKS_SECRET }}
    steps:
      - # (... add your steps here ...)
      - name: call webhook
        run: |
          echo "::add-mask::$FOR_WEBHOOKS_SECRET"
          curl --verbose --fail --show-error --location --request POST "https://api.github.com/repos/$GITHUB_REPOSITORY/dispatches" --header "Authorization: token $FOR_WEBHOOKS_SECRET" --header 'Content-Type: application/json' --header 'Accept: application/vnd.github.everest-preview+json' --data-raw "{ \"event_type\": \"delete_all_artifacts\", \"client_payload\": {\"parent_runid\": \"$GITHUB_RUN_ID\", \"parent_repo\": \"$GITHUB_REPOSITORY\"} }"
```

(Check this repo's `.github/workflow` dir for a working example)

# Reference

The action can also be used without a webhook on any past workflow run: 

## Inputs

### `parent_repo`

**Required** the github repo that hosts the parent github workflow run. Example: `"github-user/hello-world"`.

### `parent_runid`

**Required** the id of the parent github workflow run whos artifacts should get deleted. Example: `"0000000"`.


## Outputs

none (just succeeds or fails)

